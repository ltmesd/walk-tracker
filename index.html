<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SUSTEP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdXvTwv1cry2Q2yNZkCgaxpZy04YQw_sw"></script>

<style>
html,body{margin:0;height:100%;font-family:system-ui;background:#f4f7f6}
#map{height:100%;width:100%}

/* floating controls */
.controls{
  position:absolute;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(10px);
  padding:18px 22px;
  border-radius:26px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
  text-align:center;
  min-width:280px;
}

.stats{font-size:14px;margin-bottom:8px;line-height:1.5}
.time{font-size:13px;color:#666}

button{
  padding:14px 20px;
  margin:6px;
  border:none;
  border-radius:999px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:.2s ease;
}
button:active{transform:scale(.96)}
button:disabled{opacity:.4;cursor:not-allowed}

.start{background:#22c55e;color:white}
.pause{background:#f59e0b;color:white}
.finish{background:#ef4444;color:white}
</style>
</head>

<body>
<div id="map"></div>

<div class="controls">
  <div class="stats">
    à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡: <b><span id="distance">0.00</span> km</b><br>
    à¸¥à¸”à¸„à¸²à¸£à¹Œà¸šà¸­à¸™: <b><span id="carbon">0.000</span> kgCOâ‚‚e</b><br>
    <span class="time">à¹€à¸§à¸¥à¸²: <span id="time">00:00</span></span>
  </div>

  <button id="startBtn" class="start">Start</button>
  <button id="pauseBtn" class="pause">Pause</button>
  <button id="finishBtn" class="finish">Finish</button>
</div>

<!-- Summary Modal -->
<div id="summaryModal" style="
position:fixed;
inset:0;
background:rgba(0,0,0,.45);
display:none;
align-items:center;
justify-content:center;
z-index:999;">
  <div style="
    background:white;
    padding:28px;
    border-radius:24px;
    width:85%;
    max-width:320px;
    text-align:center;
    box-shadow:0 30px 80px rgba(0,0,0,.3);">
    <h2 style="margin-top:0">ðŸŽ‰ Walk Complete</h2>
    <div style="font-size:18px;margin:10px 0">
      <b id="sumDist">0.00</b> km
    </div>
    <div style="color:#666;margin-bottom:8px">
      à¹€à¸§à¸¥à¸² <b id="sumTime">00:00</b>
    </div>
    <div style="color:#16a34a;margin-bottom:20px">
      à¸¥à¸” COâ‚‚ <b id="sumCarbon">0.000</b> kg
    </div>
    <button onclick="closeSummary()" class="start">Done</button>
  </div>
</div>

<script>
// CONFIG
const EF_CAR = 0.192;
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzKDyabQAXEu_mQXcOQvm0CF55gOddh1p1jPyknpnbHplwCA8NSBsi3fbEhgv_sWLKUMA/exec";

// STATE
let map, polyline, userMarker;
let watchId=null;
let totalDistance=0;
let lastPoint=null;
let pathCoords=[];
let startTime=null;
let elapsedBeforePause=0;

let isTracking=false;
let isPaused=false;
let sessionActive=false;

let timerInterval=null;
let stillCounter=0;

// INIT
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:13.7563,lng:100.5018},
    zoom:16,
    gestureHandling:"greedy"
  });

  polyline=new google.maps.Polyline({
    map,
    path:[],
    strokeColor:"#22c55e",
    strokeWeight:5
  });

  // â­ current position dot
  userMarker=new google.maps.Marker({
    map,
    position:{lat:13.7563,lng:100.5018},
    icon:{
      path:google.maps.SymbolPath.CIRCLE,
      scale:8,
      fillColor:"#3b82f6",
      fillOpacity:1,
      strokeColor:"#ffffff",
      strokeWeight:3
    },
    zIndex:999
  });

  updateButtons();
}
window.onload=initMap;

// HAPTIC
function buzz(ms=30){
  if(navigator.vibrate) navigator.vibrate(ms);
}

// DISTANCE
function getDistance(p1,p2){
  const R=6371000,toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2.lat-p1.lat);
  const dLon=toRad(p2.lng-p1.lng);
  const a=Math.sin(dLat/2)**2+
    Math.cos(toRad(p1.lat))*Math.cos(toRad(p2.lat))*
    Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// UI
function updateUI(){
  const km=totalDistance/1000;
  document.getElementById("distance").textContent=km.toFixed(2);
  document.getElementById("carbon").textContent=(km*EF_CAR).toFixed(3);
}

function updateButtons(){
  startBtn.disabled=sessionActive;
  pauseBtn.disabled=!sessionActive;
  finishBtn.disabled=!sessionActive;
  pauseBtn.textContent=isPaused?"Resume":"Pause";
}

// TIMER
function startTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(!startTime) return;
    const diff=Date.now()-startTime;
    const min=Math.floor(diff/60000);
    const sec=Math.floor((diff%60000)/1000);
    document.getElementById("time").textContent=
      `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

// GPS
function handlePosition(pos){
  const {latitude,longitude,accuracy}=pos.coords;
  if(accuracy>30) return;

  const current={lat:latitude,lng:longitude};

  if(lastPoint){
    const dist=getDistance(lastPoint,current);
    if(dist>60) return;

    // auto pause/resume
    if(dist<0.8){
      stillCounter++;
      if(stillCounter>=6 && isTracking){
        pauseTracking(true);
      }
      return;
    }else{
      if(isPaused && stillCounter>=3){
        pauseTracking(true);
      }
      stillCounter=0;
    }

    totalDistance+=dist;
  }

  lastPoint=current;
  pathCoords.push(current);
  polyline.setPath(pathCoords);

  // move dot
  if(userMarker) userMarker.setPosition(current);

  map.panTo(current);
  map.setZoom(17);

  updateUI();
}

// START
startBtn.onclick=()=>{
  buzz(40);

  if(!sessionActive){
    resetSession();
    sessionActive=true;
    startTime=new Date();
    startTimer();
  }

  if(isTracking) return;

  isTracking=true;
  isPaused=false;

  watchId=navigator.geolocation.watchPosition(
    handlePosition,
    err=>console.error(err),
    {enableHighAccuracy:true,maximumAge:1000,timeout:10000}
  );

  updateButtons();
};

// PAUSE / RESUME
function pauseTracking(){
  buzz(30);

  if(isTracking){
    if(watchId!==null){
      navigator.geolocation.clearWatch(watchId);
      watchId=null;
    }
    elapsedBeforePause = Date.now()-startTime;
    isTracking=false;
    isPaused=true;
    stopTimer();
  }
  else if(isPaused){
    isTracking=true;
    isPaused=false;
    startTime=new Date(Date.now()-elapsedBeforePause);
    startTimer();

    watchId=navigator.geolocation.watchPosition(
      handlePosition,
      err=>console.error(err),
      {enableHighAccuracy:true,maximumAge:1000,timeout:10000}
    );
  }

  updateButtons();
}
pauseBtn.onclick=()=>pauseTracking();

// FINISH
finishBtn.onclick=async()=>{
  buzz(60);

  const ok=confirm("Finish this walk?");
  if(!ok) return;

  if(isTracking || isPaused) pauseTracking();

  stopTimer();
  await sendToSheet();

  showSummary();

  resetSession();
  sessionActive=false;
  isPaused=false;

  updateButtons();
};

// SUMMARY
function showSummary(){
  document.getElementById("sumDist").textContent=(totalDistance/1000).toFixed(2);
  document.getElementById("sumTime").textContent=document.getElementById("time").textContent;
  document.getElementById("sumCarbon").textContent=((totalDistance/1000)*EF_CAR).toFixed(3);
  document.getElementById("summaryModal").style.display="flex";
}
function closeSummary(){
  document.getElementById("summaryModal").style.display="none";
}

// RESET
function resetSession(){
  totalDistance=0;
  lastPoint=null;
  pathCoords=[];
  startTime=null;
  elapsedBeforePause=0;
  stillCounter=0;
  isPaused=false;
  isTracking=false;

  polyline.setPath([]);
  document.getElementById("time").textContent="00:00";
  updateUI();
}

// SEND
async function sendToSheet(){
  try{
    const endTime=new Date();
    const km=totalDistance/1000;
    const durationMin=startTime?(endTime-startTime)/60000:0;

    const payload={
      action:"finish",
      distance_km:Number(km.toFixed(3)),
      duration_min:Number(durationMin.toFixed(2)),
      carbon_kgco2e:Number((km*EF_CAR).toFixed(3)),
      started_at:startTime?startTime.toISOString():null,
      ended_at:endTime.toISOString(),
      path_points:pathCoords.length,
      gps_path:JSON.stringify(pathCoords)
    };

    await fetch(WEBHOOK_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
  }catch(e){ console.error(e); }
}
</script>
</body>
</html>
