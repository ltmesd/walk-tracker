// ===============================
// WALK TRACKER (FULL VERSION)
// ===============================

let watchId = null;
let startTime = null;
let totalDistance = 0;
let lastPosition = null;
let pathCoords = [];

// ===== START TRACKING =====
function startTracking() {
  console.log("Start tracking");

  totalDistance = 0;
  pathCoords = [];
  lastPosition = null;
  startTime = new Date();

  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude } = pos.coords;

      const current = { lat: latitude, lng: longitude };
      pathCoords.push(current);

      // à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡
      if (lastPosition) {
        totalDistance += getDistance(lastPosition, current);
      }

      lastPosition = current;

      console.log("Distance (m):", totalDistance.toFixed(2));
    },
    (err) => {
      console.error("GPS error:", err);
    },
    { enableHighAccuracy: true }
  );
}

// ===== STOP TRACKING =====
function stopTracking() {
  console.log("Stop tracking");

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  const endTime = new Date();
  const durationMin = (endTime - startTime) / 60000;
  const co2Saved = totalDistance * 0.00021; // à¸›à¸£à¸±à¸šà¸ªà¸¹à¸•à¸£à¹„à¸”à¹‰

  const walkData = {
    user_email: "test@email.com", // ðŸ”¥ à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡à¸„à¹ˆà¸­à¸¢à¸—à¸³ dynamic
    distance_m: Number(totalDistance.toFixed(2)),
    duration_min: Number(durationMin.toFixed(2)),
    co2_saved_kg: Number(co2Saved.toFixed(3)),
    started_at: startTime.toISOString(),
    ended_at: endTime.toISOString(),
    gps_path: JSON.stringify(pathCoords),
  };

  sendWalkToSheet(walkData);
}

// ===== SEND TO GOOGLE SHEET =====
async function sendWalkToSheet(walkData) {
  try {
    console.log("Sending to Google Sheet:", walkData);

    await fetch(
      "https://script.google.com/macros/s/AKfycbzKDyabQAXEu_mQXcOQvm0CF55gOddh1p1jPyknpnbHplwCA8NSBsi3fbEhgv_sWLKUMA/exec",
      {
        method: "POST",
        mode: "no-cors", // â­ à¸ªà¸³à¸„à¸±à¸
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(walkData),
      }
    );

    console.log("âœ… Sent to Google Sheet");
  } catch (err) {
    console.error("âŒ Send failed:", err);
  }
}

// ===== DISTANCE CALC (Haversine) =====
function getDistance(p1, p2) {
  const R = 6371000;
  const toRad = (x) => (x * Math.PI) / 180;

  const dLat = toRad(p2.lat - p1.lat);
  const dLon = toRad(p2.lng - p1.lng);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(p1.lat)) *
      Math.cos(toRad(p2.lat)) *
      Math.sin(dLon / 2) ** 2;

  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
